services:
    - docker
env:
    global:
        - DOCKER_USERNAME=beckycarter
        - DOCKER_IMAGE_NAME=todo-app
        - HEROKU_USERNAME=becky.carter@softwire.com
        - HEROKU_APP_NAME=beccar-todo-app
        - MONGO_USERNAME='travis_user'
        - MONGO_DEFAULT_DB='todo_app'
        - secure: "Zv9d5qiKBtyvxoAwskUal65XsXDDsdvxzeX8vmrLecSCYW0pfMH5FHBYwy70+9HJ8DCLRw7DYFYvp+/gkvWuzpY+QFPRqNWK4lswciHALfNl5wlU/MonyHW75HRSWr4gN9hztPaQSxYijYRlwHw1krZ+wx8Pibyan7uEop8rrI5h9rkcNPxRpFPvPHL+ETAugQI9NcounyN5pkJc1HbMGzyS3vu3dUSt4s4cGosi957xSRM0aoNxKcVb3SMMRW3YQ6OwENo14AY8w8tMRo3AMWERr8FqPzgKRRRWTtBkKG9lzFfGRKjDmkO63W4Fkl85qUJcHhwn34ki1ZhFohWHdf7QRohp0bpO5lO1OtMpbyE1d7HYw7UAAdoJPPcyT2Yux/BVmpNWxAmxvwEc4SIXJVYdLdqqVHF9TnRgFSOWOGaivt8rsxF+C0sk7DRdIlqNc3O+zd0p+RpF2LuYmAbUH/KJ5t506HWf+uZ/+8/KBx8Z63+t1f9RYvNcnkyoZdsMdssPpqSLNxluKgHlrlZTc3haVFpU0CCXSB1CI9wgXO9PS6NMndMtLDpbB1YGvYqHFzmB8QLCGfcsELA0FJ9+zv+2KiJFgnY059vzcVrYaV6/h41MhpDSVq6DuQ8ZBQmSdDXsD9/nLmGChAN/LlBx5amtwmWm9zdmwnFK395VGG4="
install:
    - docker pull $DOCKER_USERNAME/$DOCKER_IMAGE_NAME
    - docker build --target test --tag todo-app:test --cache-from $DOCKER_USERNAME/$DOCKER_IMAGE_NAME .

script:
    - docker run --mount type=bind,source="$(pwd)",target=/app todo-app:test tests/unit
    - docker run --mount type=bind,source="$(pwd)",target=/app todo-app:test tests/integration
    - docker run -e MONGO_USERNAME -e MONGO_PASSWORD -e MONGO_URL -e MONGO_DEFAULT_DB --mount type=bind,source="$(pwd)",target=/app todo-app:test tests/end_to_end
    
before_deploy:
    - echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin
    - heroku container:login
deploy:
    provider: script
    script:  bash scripts/deploy.sh
    on:
      branch: master
